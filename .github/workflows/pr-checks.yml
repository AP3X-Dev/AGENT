# AG3NT Pull Request Checks
# Additional checks specific to pull requests

name: "üìù PR Checks"

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # PR Title Validation (Conventional Commits)
  # ============================================
  pr-title:
    name: "üìã PR Title"
    runs-on: ubuntu-latest
    steps:
      - name: "‚úÖ Validate Conventional Commits Format"
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            gateway
            agent
            skills
            ui
            api
            deps
            config
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            should start with a lowercase letter.

  # ============================================
  # Changed Files Detection
  # ============================================
  changes:
    name: "üîç Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.filter.outputs.gateway }}
      agent: ${{ steps.filter.outputs.agent }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: "üìã Checkout Code"
        uses: actions/checkout@v4

      - name: "üîç Filter Changed Paths"
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'apps/gateway/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            agent:
              - 'apps/agent/**'
              - 'requirements.txt'
            docs:
              - '**/*.md'
              - 'docs/**'

  # ============================================
  # Size Check
  # ============================================
  size-check:
    name: "üìè PR Size"
    runs-on: ubuntu-latest
    steps:
      - name: "üìã Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üìè Check PR Size"
        run: |
          # Get the number of changed lines
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $2} END {print sum}')
          TOTAL=$((ADDITIONS + DELETIONS))
          
          echo "üìä PR Statistics:"
          echo "  Additions: +$ADDITIONS"
          echo "  Deletions: -$DELETIONS"
          echo "  Total: $TOTAL lines changed"
          
          # Warn if PR is too large (>1000 lines)
          if [ "$TOTAL" -gt 1000 ]; then
            echo "‚ö†Ô∏è Warning: This PR is quite large ($TOTAL lines). Consider breaking it into smaller PRs."
          fi
          
          # Fail if PR is extremely large (>3000 lines)
          if [ "$TOTAL" -gt 3000 ]; then
            echo "‚ùå Error: This PR is too large ($TOTAL lines). Please break it into smaller PRs."
            exit 1
          fi

